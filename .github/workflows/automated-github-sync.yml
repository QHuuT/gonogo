name: Automated GitHub â†’ Database Sync

on:
  # Run every 6 hours
  schedule:
    - cron: '0 */6 * * *'

  # Run when GitHub issues are created/updated
  issues:
    types: [opened, edited, closed, reopened]

  # Manual trigger
  workflow_dispatch:
    inputs:
      force_full_sync:
        description: 'Force full sync (clears existing data)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  issues: read

jobs:
  sync-github-to-database:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install requests

      - name: Initialize database with migrations
        run: |
          alembic upgrade head

      - name: Download existing database if available
        continue-on-error: true
        run: |
          # Try to download the existing database from repo artifacts
          gh run download --repo ${{ github.repository }} --name rtm-database || echo "No existing database found"
          if [ -f gonogo.db ]; then
            echo "ğŸ“¥ Downloaded existing database"
            ls -la gonogo.db
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync GitHub issues to database
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_FULL_SYNC: ${{ github.event.inputs.force_full_sync || 'false' }}
        run: |
          echo "ğŸ”„ Starting automated GitHub â†’ Database sync"
          echo "Force full sync: $FORCE_FULL_SYNC"

          if [ "$FORCE_FULL_SYNC" = "true" ]; then
            echo "ğŸ§¹ Force full sync requested - will clear existing data"
            python tools/import_real_github_data.py --import
          else
            echo "ğŸ“¥ Incremental sync - preserving existing data"
            python tools/import_real_github_data.py --import
          fi

      - name: Verify database content
        run: |
          echo "ğŸ“Š Database content verification:"
          python -c "
          from src.be.database import get_db_session
          from src.be.models.traceability import Epic, UserStory, Defect, Test

          db = get_db_session()
          try:
              epic_count = db.query(Epic).count()
              us_count = db.query(UserStory).count()
              defect_count = db.query(Defect).count()
              test_count = db.query(Test).count()

              print(f'âœ… Database sync completed:')
              print(f'   ğŸ“ˆ Epics: {epic_count}')
              print(f'   ğŸ“‹ User Stories: {us_count}')
              print(f'   ğŸ› Defects: {defect_count}')
              print(f'   ğŸ§ª Tests: {test_count}')

              if epic_count == 0 and us_count == 0:
                  print('âš ï¸ WARNING: Database appears to be empty!')
                  exit(1)
          finally:
              db.close()
          "

      - name: Upload database as artifact
        uses: actions/upload-artifact@v4
        with:
          name: rtm-database
          path: gonogo.db
          retention-days: 90

      - name: Commit database to repository
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action - RTM Sync"

          if [ -f gonogo.db ]; then
            # Check if database has changed
            if git diff --quiet gonogo.db 2>/dev/null; then
              echo "ğŸ“Š Database unchanged, no commit needed"
            else
              echo "ğŸ’¾ Database updated, committing changes"
              git add gonogo.db
              git commit -m "automated: sync RTM database from GitHub issues

              ğŸ“Š Automated sync: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
              ğŸ”„ Source: GitHub Issues â†’ RTM Database
              ğŸ“ˆ Trigger: ${{ github.event_name }}

              ğŸ¤– Generated with GitHub Actions
              " || echo "No changes to commit"

              git push origin ${{ github.ref_name }}
              echo "âœ… Database changes pushed to repository"
            fi
          else
            echo "âŒ Database file not found after sync"
            exit 1
          fi

      - name: Generate RTM report
        continue-on-error: true
        run: |
          echo "ğŸ“Š Generating RTM report..."

          # Start server in background
          python -m uvicorn src.be.main:app --host 0.0.0.0 --port 8000 &
          SERVER_PID=$!

          # Wait for server to start
          sleep 10

          # Generate HTML report
          curl -f "http://localhost:8000/api/rtm/reports/matrix?format=html" -o rtm_report.html

          # Kill server
          kill $SERVER_PID 2>/dev/null || true

          echo "âœ… RTM report generated"

      - name: Upload RTM report
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: rtm-report-${{ github.run_number }}
          path: rtm_report.html
          retention-days: 30

      - name: Sync summary
        run: |
          echo "ğŸ‰ Automated GitHub â†’ Database sync completed!"
          echo ""
          echo "ğŸ“Š **Sync Results:**"
          echo "- âœ… GitHub issues synced to database"
          echo "- ğŸ’¾ Database committed to repository"
          echo "- ğŸ“Š RTM report generated"
          echo "- ğŸ—‚ï¸ Artifacts uploaded"
          echo ""
          echo "ğŸŒ **Next Steps:**"
          echo "- Pull latest changes to get updated database: \`git pull\`"
          echo "- Start local RTM server: \`python -m uvicorn src.be.main:app --reload --host 0.0.0.0 --port 8000\`"
          echo "- View RTM dashboard: http://localhost:8000/api/rtm/reports/matrix?format=html"